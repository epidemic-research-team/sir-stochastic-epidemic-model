---
title: "R Notebook"
output:
  html_notebook:
    toc: yes
    code_folding: hide
---
```{r setup, include = FALSE}

library(data.table)
library(ggplot2)
library(EpiDynamics)

# From the HawkesN paper
# https://github.com/computationalmedia/sir-hawkes/blob/master/sir-hawkes-tutorial.ipynb
library(parallel)
source('scripts/functions-SIR-HawkesN.R')
source('scripts/functions-size-distribution.R')
```
# An Overview of the SIR-Hawkes Model

This is an overview of the [SIR-Hawkes: Linking Epidemic Models and Hawkes Processes to Model Diffusions in Finite Populations](http://rmarkdown.rstudio.com) by Xie et al. 

## Main Aims of the Paper

1. The authors adjust `Hawkes` process to include the remaining (after the infected have been taken into account) population ratio ($\frac{N_{t}}{N}$) and an exponential kernel; the new process is named `HawkesN`, with parameters $N$, $\kappa$, $\theta$, $\mu$. 

$$
\lambda(t)^{H} = \bigg(1 - \frac{N_{t}}{N} \bigg) \bigg[ \mu + \sum_{t_{j}<t} \kappa \theta exp^{-\theta (t - t_{j})} \bigg]
$$

2. The paper shows that the rate of events in `HawkesN` is identical to the expected rate of new infections in `SIR` after marginalizing out recovery events, with $\lambda(t)^{I}$ the rate of *new* infection (`SIR` model) and $\lambda(t)^{H}$ the historical event rate (`HawkesN` process).

$$
\mathbb{E}[\lambda(t)^{I}] = \lambda(t)^{H}
$$

3. Also, the authors estimate the population size $N$ in `HawkesN` from observed data and construct a lower bound statistic to detect when parameter $N$ does not have a valid solution.

$$
\sum_{1}^{n} \frac{j - 1}{N(N - j + 1)} - \frac{1}{N^{2}}\sum_{j=0}^{n-1}\sum_{l=j}^{n-1}lk[exp^{-\theta(l-j) - exp^{-\theta(l+1 - j)}}] = 0
$$

4. Finally, they use a `Markov chain` tool from epidemic model theory to predict the distribution of the final size of a cascade.

## Foundations for the SIR - Hawkes paper

The authors have built their model on three main foundations; `Poisson` processes, `Hawkes` process and `SIR` epidemic model. 

### 1. Poisson Process
The bedrock of event modelling is the `Poisson` process. Specifically, in a non-homogeneous `Poisson` process, the events are independent with the probability of an event happening at time $t$ varies with $t$. So, the **event rate** of the `Poisson` process is a deterministic time-continuous function $\lambda(t)$ [1](https://arxiv.org/pdf/1711.01679.pdf) [2](https://arxiv.org/pdf/1612.09328.pdf). 

### 2. Hawkes process 
The `Hawkes` process supposes that past events can temporarily raise the probability of future events, assuming that such excitation is positive, additive over the past events, and exponentially decaying with time.

$$
\lambda(t) = \mu + \sum_{t_{j}<t}\phi(t - t_{j})
$$
with $j$ being the event, $\phi$ the kernel of the Hawkes process and $\mu$ the base intensity of the event. In other words, a new event either enters the system at the background rate $\mu$; or it is generated by a previous event at the rate of the corresponding kernel function $\phi$ [1](https://arxiv.org/pdf/1711.01679.pdf).

### 3. Deterministic SIR model
The `SIR` model, is an epidemic model that at each point in time $t$ defines three stages of a population, the number of people who are susceptible to a virus $S$, the number of people who are infected by that virus $I$ and the people who have recovered from that virus. $R$

$$
\begin{aligned}
\frac{dS(t)}{dt} &=  -\beta \frac{S(t)}{N} I(t) \\
\frac{dI(t)}{dt} &=  \beta \frac{S(t)}{N} I(t) - \gamma I(t) \\
\frac{dR(t)}{dt} &=  \gamma I(t)
\end{aligned}
$$

with a constant population size $N = S(t) + I(t) + R(t)$. As an example, the process a virus can infect people according to `SIR` model is as depicted on the below graph (for the graph and the `SIR` the **R** package `EpiDynamics` has been used [3](https://CRAN.R-project.org/package=EpiDynamics))

```{r echo=FALSE, warning=FALSE}
# Parameters and initial conditions.
parameters <- c(beta = 1.4247, gamma = 0.14286)
initials <- c(S = 1 - 1e-06, I = 1e-06, R = 1 - (1 - 1e-06 - 1e-06))

# Solve and plot.
sir <- SIR(pars = parameters, init = initials, time = 0:70)
sir <- as.data.table(sir$results)
sir.melt <- melt(sir, id.vars = c("time"),
                measure.vars = c("S", "I", "R"))
setnames(sir.melt, c("time", "variable", "value"), 
         c("Time", "Groups", "Proportion")) 

# Plot
ggplot(sir.melt, aes(x=Time, y=Proportion, fill=Groups)) + 
    geom_area(alpha=0.6 , size=1, colour="black")

```

### 4. Stochastic SIR model
The stochastic `SIR` model follows the same assumptions as the deterministic `SIR` method and the authors follow the bivariate point process representation [1](https://arxiv.org/pdf/1711.01679.pdf)(p.3). In general, the stochastic transition probabilities in terms of `SIR` ODE are 

$$
sSIR = 
  \begin{cases} 
   \beta \frac{S_{t}}{N} I_{t} \Delta t + o(\Delta t) & \text{if infectius } (k, j)=(-1, +1) \\
   \gamma I_{t} \Delta t + o(\Delta t) & \text{if recovery } (k, j)=(0, -1) \\
   1 - \bigg(\beta \frac{S_{t}}{N} I_{t} + \gamma I_{t}\bigg) \Delta t + o(\Delta t) & \text{if susceptible } (k, j)=(0, 0) \\
   o(\Delta t)      & \text{otherwise}
  \end{cases}
$$

where $S_{t}$, $I_{t}$ is the stochastic equivalents of $S(t)$ and $I(t)$. From this, we define the counting process of the infectious and recovered as $C_{t} = I_{t} + R_{t}$, where $C_{t} = N - S_{t}$, with a time to recovery $\tau = t^{R}_{j} - t^{I}_{j}$

```{r}
# Run the HawkesN CRAN package for R
params.S <- c(N = 1300, I.0 = 300, gamma = 0.14286, beta = 1.4247)
nsim <- 70
simdat <- replicate(
    n = nsim,
    generate.stochastic.sir(params = params.S, Tmax = 11, hide.output = T)    
)

as.data.frame(simdat[,1])[1:20,]
```
The connection between the deterministic and the stochastic population sizes is $S(t) = \mathbb{E}_{\mathcal{H}_{t}} [S_{t}]$, $I(t) = \mathbb{E}_{\mathcal{H}_{t}} [I_{t}]$ and $R(t) = \mathbb{E}_{\mathcal{H}_{t}} [R_{t}]$, with $\mathcal{H}_{t}$ be the history of the bivariate epidemic process up to time $t$ [1](https://arxiv.org/pdf/1711.01679.pdf)(p.4).

## Mathematical Model

The authors aim to link the `SIR` model to the `Hawkes` process. The steps they follow are

### 1. Generelise the `Hawkes` process, `HawkesN`

The authors, generelised the standard `Hawkes` process by taking into account the ratio of the available remaining population that can get infected ($1 - \frac{N_{t}}{N}$).

$$
\lambda^{H}(t) = \bigg( 1-\frac{N_{t}}{N} \bigg)\bigg[\mu + \sum_{t_{j}<t}\phi(t - t_{j}) \bigg]
$$

with $\mu$ the base intensity of the event, $N$ the fixed total population, $N_{t}$ the counting associated with the **point** process, and $\phi$ the `Hawkes` kernel as an exponential function

$$
\phi(t - t_{j}) = \kappa \theta exp^{-\theta (t - t_{j})} 
$$

The kernel gives us the rate that past events $\mathcal{H}_{t}$ generate new ones. 

```{r echo=TRUE}
# 1. Get the means at given time points, to be able to compare to deterministic
simhistory <- sapply(X = 1:nsim, FUN = function(i) {
  history.S <- SIR2HAWKES.stochastic.event.series(state = simdat[,i])  
})

# 2. Set a start point 
params.fit.start <- c(K = 1, c = 0.1, theta = 0.1, N = 1000)

# 3. Fit the event series with HawkesN
.cl <- makeCluster(spec = min(20, detectCores()), type = 'FORK')
results <- parSapply(cl = .cl, X = 1:nsim, FUN = function(i) {
  history.S <- as.data.frame(simhistory[,i])
  fitted.model <- fitSeries(history = history.S, params.fit.start)
})
stopCluster(.cl)
res <- as.data.frame(results['par',])
names(res) <- 1:nsim
res <- data.frame(t(res))

res
```

### 2. Link the `sSIR` model with the `HawkesN` process

The link between the modified `HawkesN` process and the stochastic `SIR` model is at the event intensity $\lambda(t)$. Particularly, the expected event intensity over times to recovery $T$ ($\tau = t^{R}_{j} - t^{I}_{j}$) of the infectious in the stochastic `SIR` equals the `HawkesN` process, when $\mu=0$, $\beta=\kappa \theta$, $\gamma=\theta$.

$$
\mathbb{E}_{T}[\lambda(t)] = \lambda^{H}(t)
$$

The proof follows, as we saw before $C_{t} = I_{t} + R_{t}$, where $C_{t} = N - S_{t}$, with a time to recovery $\tau_{j} = t^{R}_{j} - t^{I}_{j}$. So we express $S$ and $I$ as indicator functions

$$
\begin{aligned}
S_{t} &= N - C_{t} = N - \sum_{j \geq 1} \mathbb{1}(t^{I}_{j}<t)   \\
I_{t} &= C_{t} - R_{t} = \sum_{j \geq 1} \mathbb{1}(t^{I}_{j}<t, t^{R}_{j}>t) =  \sum_{t^{I}_{j} \geq 1} \mathbb{1}(t^{I}_{j} + \tau_{j}>t)
\end{aligned}
$$

The susceptible $S_{t}$, is a discrete random variable integer value and counts the sum of the people that have been infected by time $t$, subtracted by the total population $N$. The infectious $I_{t}$, is also an integer value and is the sum of infectious events (including the recovery time) up to time $t$.

Next, the authors marginalise out the time to recover in order to link the `HawkesN` process to the `sSIR` model. 

$$
\begin{aligned}
\mathbb{E}_{\mathcal{T}}\bigg[ \lambda^{I}(t) \bigg] & = \mathbb{E}_{\mathcal{T}}\bigg[ \beta\frac{S_{t}}{N}I_{t} \bigg] \\
&= \mathbb{E}_{\mathcal{T}} \bigg[ \beta\frac{S_{t}}{N} \sum_{t^{I}_{j} \geq 1} \mathbb{1}(t^{I}_{j} + \tau_{j}>t) \bigg] \\
&= \sum_{t^{I}_{j} \geq 1} \mathbb{E}_{\mathcal{T}} \bigg[ \beta\frac{S_{t}}{N} \mathbb{1}(t^{I}_{j} + \tau_{j}>t) \bigg] \\
&= \sum_{t^{I}_{j} \geq 1} \int^{\inf}_{0}  \beta\frac{S_{t}}{N} \mathbb{1}(t^{I}_{j} + \tau_{j}>t)r(\zeta)d\zeta  \\
&= \sum_{t^{I}_{j} \geq 1} \int^{\inf}_{0}  \beta\frac{S_{t}}{N} \mathbb{1}(t^{I}_{j} + \zeta>t)r(\zeta)d\zeta  \\
&= \sum_{t^{I}_{j} \geq 1} \beta\frac{S_{t}}{N} \int^{\inf}_{0} r(\zeta)d\zeta  \\
\end{aligned}
$$

replacing $S_{t}$ with $S_{t} = N - C_{t} = N - (I_{t} + R_{t})$ and setting $r(\zeta) = \kappa \theta exp^{-\theta (t - t_{j})}$, we obtain the `HawkesN` and `sSIR` link, with parameters $N$, $\kappa$, $\theta$. 

$$
\begin{aligned}
\mathbb{E}_{\mathcal{T}}\bigg[ \lambda^{I}(t) \bigg] &= \bigg(\frac{N}{N} - \frac{I_{t} + R_{t}}{N} \bigg) \bigg[ \sum_{t_{j}<t} \kappa \theta exp^{-\theta (t - t_{j})} \bigg] \\
&= \bigg(1 - \frac{N_{t}}{N} \bigg) \bigg[ \sum_{t_{j}<t} \kappa \theta exp^{-\theta (t - t_{j})} \bigg] 
\end{aligned}
$$

### 3. Infer the population $N$ from the `HawkesN` process

In this section the authors, examine the popilation $N$ is the only unknown parameters from the $N$, $\kappa$, $\theta$. 

First, the create the log-likelihood of `HawkesN`

$$
\mathcal{L}(\kappa, \theta, N)=\sum_{j=1}^{n} log \lambda^{H}(t_{j}) - \int^{t_{n}}_{0}\lambda^{H}(\tau)d\tau 
$$





